<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AntDash | AI ì£¼ì‹ ëŒ€ì‹œë³´ë“œ</title>
    <style>
        :root { --bg: #f4f7fa; --card: #ffffff; --primary: #2962ff; --text: #1e293b; --red: #f44336; --blue: #2196f3; --gray: #64748b; }
        body { font-family: 'Pretendard', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; }
        header { background: #0f172a; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { display: grid; grid-template-columns: 280px 1fr 320px; gap: 24px; padding: 24px; max-width: 1500px; margin: auto; }
        .card { background: var(--card); border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 24px; border: 1px solid rgba(0,0,0,0.03); }
        h3 { margin-top: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; color: #334155; }
        .index-item, .stock-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 12px; background: #f8fafc; border-radius: 10px; font-size: 0.95rem; }
        .stock-item { border: 1px solid #e2e8f0; }
        .up { color: var(--red); font-weight: bold; }
        .down { color: var(--blue); font-weight: bold; }
        .btn-del { font-size: 0.8rem; color: #aaa; cursor: pointer; margin-left: 10px; }
        .news-item { margin-bottom: 16px; padding: 16px; border-radius: 12px; border: 1px solid #f1f5f9; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
        .news-item:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .sentiment-bar { height: 4px; width: 100%; position: absolute; top: 0; left: 0; background: #eee; }
        .sentiment-fill { height: 100%; }
        .news-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; margin-top: 8px; }
        .badge { font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; font-weight: 700; color: white; }
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; }
        .btn-primary { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-sm { width: auto; padding: 8px 12px; font-size: 0.9rem; margin-top: 5px; }
        @media (max-width: 1100px) { .container { grid-template-columns: 1fr; } .container aside, .container section { display: none; } }
    </style>
</head>
<body>
<header>
    <div style="font-size: 1.5rem; font-weight: 900;">ğŸœ AntDash <span style="font-size: 0.9rem; opacity: 0.7;">Pro</span></div>
    <div id="realtime-clock" style="font-family: monospace;">--:--:--</div>
</header>
<div class="container">
    <aside>
        <div class="card">
            <h3>ğŸ“Š ì£¼ìš” ì§€ìˆ˜</h3>
            <div id="indices-list">
                <div style="text-align:center; color:#999;">ë¡œë”©ì¤‘...</div>
            </div>
        </div>
        <div class="card">
            <h3>â­ ê´€ì‹¬ ì¢…ëª© (Watchlist)</h3>
            <div id="watchlist-container"></div>
            <div style="margin-top: 15px; display: flex; gap: 5px;">
                <input type="text" id="new-stock-code" placeholder="ì¢…ëª©ì½”ë“œ (ì˜ˆ: 005930.KS)">
                <button class="btn-primary btn-sm" onclick="addStock()">ì¶”ê°€</button>
            </div>
            <p style="font-size: 0.75rem; color: #999; margin-top: 5px;">
                * ì½”ìŠ¤í”¼: .KS / ì½”ìŠ¤ë‹¥: .KQ<br>
                ì˜ˆ) ì‚¼ì„±ì „ì: 005930.KS<br>
                ì˜ˆ) ì—ì½”í”„ë¡œ: 086520.KQ
            </p>
        </div>
    </aside>
    <main>
        <div class="card">
            <h3>ğŸ—ï¸ AI ë‰´ìŠ¤ ê°ì„± ë¶„ì„</h3>
            <div id="news-list">
                <p style="text-align:center; padding: 20px; color: var(--gray);">
                    ğŸ¤– AIê°€ ë‰´ìŠ¤ë¥¼ ë¶„ì„í•˜ê³  ì ìˆ˜ë¥¼ ë§¤ê¸°ëŠ” ì¤‘...
                </p>
            </div>
        </div>
    </main>
    <section>
        <div class="card">
            <h3>ğŸ§® ë¬¼íƒ€ê¸° ê³„ì‚°ê¸°</h3>
            <div class="input-group">
                <input type="number" id="p1" placeholder="ê¸°ì¡´ í‰ë‹¨ê°€">
                <input type="number" id="q1" placeholder="ë³´ìœ  ìˆ˜ëŸ‰" style="margin-top:5px;">
            </div>
            <div class="input-group">
                <input type="number" id="p2" placeholder="ì¶”ê°€ ë§¤ìˆ˜ í‰ë‹¨ê°€">
                <input type="number" id="q2" placeholder="ì¶”ê°€ ë§¤ìˆ˜ ìˆ˜ëŸ‰" style="margin-top:5px;">
            </div>
            <button class="btn-primary" onclick="calculateAverage()">ê³„ì‚°í•˜ê¸°</button>
            <div id="calc-result" style="margin-top: 15px; padding: 10px; background: #f8fafc; border-radius: 8px; display: none;">
                <strong>ìµœì¢… í‰ë‹¨: <span id="res-price">0</span>ì›</strong>
            </div>
        </div>
    </section>
</div>
<script>
    setInterval(() => document.getElementById('realtime-clock').innerText = new Date().toLocaleString(), 1000);

    async function fetchIndices() {
        try {
            const res = await fetch('/api/indices');
            const data = await res.json();
            const list = document.getElementById('indices-list');
            
            const items = [
                { name: 'ì½”ìŠ¤í”¼', ...data.kospi },
                { name: 'ì½”ìŠ¤ë‹¥', ...data.kosdaq },
                { name: 'í™˜ìœ¨', ...data.exchange }
            ];

            list.innerHTML = items.map(item => `
                <div class="index-item">
                    <span>${item.name}</span>
                    <span class="${item.isUp ? 'up' : 'down'}">
                        ${item.price} ${item.isUp ? 'â–²' : 'â–¼'} (${item.percent}%)
                    </span>
                </div>
            `).join('');
        } catch(e) { console.error(e); }
    }

    let myStocks = JSON.parse(localStorage.getItem('myStocks')) || ['005930.KS', '000660.KS'];

    async function fetchWatchlist() {
        if(myStocks.length === 0) return;
        const container = document.getElementById('watchlist-container');
        container.innerHTML = "<div style='font-size:0.8rem; color:#999; text-align:center;'>ì‹œì„¸ ì¡°íšŒ ì¤‘...</div>";

        try {
            const res = await fetch(`/api/stock?symbols=${myStocks.join(',')}`);
            if (!res.ok) throw new Error(`ì„œë²„ ì—ëŸ¬ (${res.status})`);
            
            const data = await res.json();
            
            if (data.length === 0) {
                container.innerHTML = "<div style='font-size:0.8rem; text-align:center;'>ë°ì´í„° ì—†ìŒ (ì¢…ëª©ì½”ë“œ í™•ì¸ í•„ìš”)</div>";
                return;
            }

            container.innerHTML = data.map(stock => {
                const isUp = stock.change > 0;
                const priceDisplay = stock.price === 0 ? "ì¡°íšŒ ë¶ˆê°€" : stock.price.toLocaleString() + "ì›";
                return `
                <div class="stock-item">
                    <div>
                        <div style="font-weight:bold; font-size:0.9rem;">${stock.symbol}</div>
                        <div style="font-size:0.8rem; color:#666;">${priceDisplay}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="${isUp ? 'up' : 'down'}" style="font-weight:bold;">
                            ${isUp ? '+' : ''}${stock.percent.toFixed(2)}%
                        </span>
                        <span class="btn-del" onclick="removeStock('${stock.symbol}')">âœ•</span>
                    </div>
                </div>`;
            }).join('');
        } catch(e) { 
            console.error(e); 
            container.innerHTML = `<div style='font-size:0.8rem; color:red; text-align:center;'>ë¡œë”© ì‹¤íŒ¨: ${e.message}</div>`;
        }
    }

    async function addStock() {
        const input = document.getElementById('new-stock-code');
        const code = input.value.toUpperCase().trim();
        if(!code) return alert("ì¢…ëª© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 005930.KS)");
        if(myStocks.includes(code)) return alert("ì´ë¯¸ ì¶”ê°€ëœ ì¢…ëª©ì…ë‹ˆë‹¤.");
        
        const btn = document.querySelector('.btn-sm');
        const originalText = btn.innerText;
        btn.innerText = "â³";
        btn.disabled = true;

        try {
            myStocks.push(code);
            localStorage.setItem('myStocks', JSON.stringify(myStocks));
            await fetchWatchlist();
            input.value = '';
        } catch (e) {
            alert("ì¢…ëª© ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    function removeStock(symbol) {
        myStocks = myStocks.filter(s => s !== symbol);
        localStorage.setItem('myStocks', JSON.stringify(myStocks));
        fetchWatchlist();
        if(myStocks.length === 0) document.getElementById('watchlist-container').innerHTML = "<div style='font-size:0.8rem; text-align:center;'>ì¢…ëª©ì„ ì¶”ê°€í•´ë³´ì„¸ìš”</div>";
    }

    async function fetchNews() {
        const list = document.getElementById('news-list');
        try {
            const res = await fetch('/api/news');
            const data = await res.json();

            list.innerHTML = data.map(news => {
                let color = "#94a3b8"; 
                let label = "ì¤‘ë¦½";
                let score = news.score || 50;
                
                if(news.sentiment.includes("í˜¸ì¬")) {
                    color = "#2563eb"; label = "í˜¸ì¬";
                } else if(news.sentiment.includes("ì•…ì¬")) {
                    color = "#dc2626"; label = "ì•…ì¬";
                }

                return `
                    <div class="news-item" onclick="window.open('${news.link}', '_blank')">
                        <div class="sentiment-bar">
                            <div class="sentiment-fill" style="width: ${score}%; background: ${color}; opacity: 0.3;"></div>
                        </div>
                        <div class="news-header">
                            <span class="badge" style="background:${color};">${label} ${score}ì </span>
                            <span style="font-size: 0.8rem; color: #999;">${news.date}</span>
                        </div>
                        <div style="font-weight: bold; font-size: 1.05rem; margin-bottom: 5px;">${news.title}</div>
                        <div style="font-size: 0.9rem; color: #666;">${news.description}</div>
                        <div style="margin-top:8px; font-size:0.75rem; color:${color}; font-weight:bold;">
                            ${label === 'í˜¸ì¬' ? 'ğŸ“ˆ ì£¼ê°€ ìƒìŠ¹ ìš”ì¸' : (label === 'ì•…ì¬' ? 'ğŸ“‰ ì£¼ì˜ í•„ìš”' : 'ğŸ‘€ ì‹œì¥ ê´€ë§ì„¸')}
                        </div>
                    </div>
                `;
            }).join('');
        } catch(e) { console.error(e); }
    }

    function calculateAverage() {
        const p1 = parseFloat(document.getElementById('p1').value) || 0;
        const q1 = parseFloat(document.getElementById('q1').value) || 0;
        const p2 = parseFloat(document.getElementById('p2').value) || 0;
        const q2 = parseFloat(document.getElementById('q2').value) || 0;
        if((p1*q1 + p2*q2) === 0) return;
        const total = (p1*q1 + p2*q2) / (q1+q2);
        document.getElementById('res-price').innerText = Math.round(total).toLocaleString();
        document.getElementById('calc-result').style.display = 'block';
    }

    window.onload = function() {
        fetchIndices();
        fetchWatchlist();
        fetchNews();
    };
</script>
</body>
</html>
